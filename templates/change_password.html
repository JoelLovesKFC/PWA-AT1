{% extends "base.html" %}
{% block title %}Change Password â€¢ Nobu{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h1 class="h5 mb-4">Change Password</h1>

          <form id="changePasswordForm" class="row g-3">
            <!-- Current password (single toggle controls ALL fields) -->
            <div class="col-12">
              <label for="current_password" class="form-label">Current password</label>
              <div class="input-group">
                <input id="current_password" name="current_password"
                       class="form-control bg-warning-subtle pw-field"
                       type="password" autocomplete="current-password" required>
                <button id="toggleAllPw" class="btn btn-outline-secondary"
                        type="button" aria-label="Show passwords" aria-pressed="false">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
            </div>

            <!-- New password -->
            <div class="col-12 col-md-6">
              <label for="new_password" class="form-label">New password</label>
              <input id="new_password" name="new_password"
                     class="form-control pw-field"
                     type="password" autocomplete="new-password" minlength="5" required>
            </div>

            <!-- Confirm new password -->
            <div class="col-12 col-md-6">
              <label for="confirm_password" class="form-label">Confirm new password</label>
              <input id="confirm_password" name="confirm_password"
                     class="form-control pw-field"
                     type="password" autocomplete="new-password" minlength="5" required>
            </div>

            <div class="col-12 d-flex gap-2 mt-2">
              <button class="btn btn-primary" type="submit">Update password</button>
              <a href="/profile" class="btn btn-outline-secondary">Back to profile</a>
            </div>
          </form>

          <div id="cpMsg" class="alert d-none mt-3" role="alert"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
  // ONE toggle for all password fields
  (function(){
    const btn = document.getElementById('toggleAllPw');
    const icon = btn?.querySelector('i');
    let shown = false;

    btn?.addEventListener('click', () => {
      shown = !shown;
      document.querySelectorAll('.pw-field').forEach(inp => {
        if (inp) inp.type = shown ? 'text' : 'password';
      });
      btn.setAttribute('aria-pressed', String(shown));
      btn.setAttribute('aria-label', (shown ? 'Hide' : 'Show') + ' passwords');
      icon?.classList.toggle('bi-eye', !shown);
      icon?.classList.toggle('bi-eye-slash', shown);
    });

    // Submit handler (keeps your existing API)
    const form = document.getElementById('changePasswordForm');
    const msg  = document.getElementById('cpMsg');
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.className = 'alert d-none';
      const body = {
        current_password: document.getElementById('current_password').value,
        new_password:     document.getElementById('new_password').value,
        confirm_password: document.getElementById('confirm_password').value,
      };
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      try {
        const res  = await fetch('/api/change_password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        msg.className = `alert mt-3 ${res.ok ? 'alert-success' : 'alert-danger'}`;
        msg.textContent = data.message || (res.ok ? 'Password updated.' : 'Something went wrong.');
        if (res.ok) form.reset();
      } catch {
        msg.className = 'alert alert-danger mt-3';
        msg.textContent = 'Network error. Try again.';
      } finally {
        submitBtn.disabled = false;
      }
    });
  })();
</script>
{% endblock %}
